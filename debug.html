<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muscle & Blood Debug</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222;
            font-family: Arial, sans-serif;
            color: #eee;
        }
        #debugInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #debugInfo h3 {
            margin-top: 0;
            color: #fff;
        }
        #debugInfo h4 {
            margin: 10px 0 5px 0;
            color: #ccc;
        }
        #debugInfo p {
            margin: 0;
            font-size: 0.9em;
        }
        #debugInfo button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            margin-bottom: 5px;
        }
        #debugInfo button:hover {
            background-color: #45a049;
        }
        #debugInfo button.fault-btn {
            background-color: #f44336;
        }
        #debugInfo button.fault-btn:hover {
            background-color: #d32f2f;
        }
        canvas {
            border: 2px solid #fff;
            background-color: #000;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
        }
        .overlay-canvas {
            position: absolute;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
        }
        #mercenaryPanelCanvas {
            top: 0;
            height: 100px;
            border-bottom: 2px solid #555;
        }
        #combatLogCanvas {
            bottom: 0;
            height: 150px;
            border-top: 2px solid #555;
        }
    </style>
</head>
<body>
    <div id="debugInfo">
        <h3>디버그 정보</h3>
        <p>FPS: <span id="fpsCounter">--</span></p>
        <p>메모리: <span id="memoryInfo">N/A</span></p>
        <p>마우스: <span id="mousePos">N/A</span></p>
        <p>터치: <span id="touchPos">N/A</span></p>
        <p>게임 시간: <span id="gameTime">0s</span></p>
        <h4>커스텀 디버그</h4>
        <div id="customDebugInfo">N/A</div>

        <hr/>
        <h4>시스템 제어</h4>
        <button id="toggleDisarmSystemBtn">무장해제 시스템: --</button>
        <button id="simulateEventsBtn">이벤트 시뮬레이션 시작</button>

        <hr/>
        <h4>전투 계산 테스트</h4>
        <button id="testDamageCalculationBtn">대미지 계산 테스트 (전사 -> 해골)</button>

        <hr/>
        <h4>상태 이상 테스트</h4>
        <button id="applyPoisonToSkeletonBtn">해골에 독 적용 (3턴)</button>
        <button id="applyStunToSkeletonBtn">해골에 기절 적용 (1턴)</button>
        <button id="applyBerserkToWarriorBtn">전사에 광폭화 적용 (2턴)</button>
        <button id="clearAllEffectsBtn">모든 효과 제거 (전체)</button>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <canvas id="mercenaryPanelCanvas" class="overlay-canvas"></canvas>
        <canvas id="combatLogCanvas" class="overlay-canvas"></canvas>
    </div>

    <!-- Core engine scripts (non-module) -->
    <script src="js/resolutionEngine.js"></script>
    <script src="js/measurementEngine.js"></script>
    <script src="js/gameEngine.js"></script>
    <script src="js/managers/cameraEngine.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/inputManager.js"></script>
    <script src="js/assetLoader.js"></script>
    <script src="js/debugManager.js"></script>
    <script src="js/gameLoop.js"></script>
    <script src="js/managers/layerEngine.js"></script>
    <script src="js/managers/panelEngine.js"></script>
    <script src="js/managers/uiEngine.js"></script>
    <script src="js/managers/turnEngine.js"></script>
    <script src="js/managers/delayEngine.js"></script>
    <script src="js/managers/gridEngine.js"></script>
    <script src="js/managers/battleLogEngine.js"></script>
    <script src="js/managers/battleGridManager.js"></script>
    <script src="js/managers/mercenaryPanelGridManager.js"></script>
    <script src="js/managers/battleStageManager.js"></script>

    <!-- Debug initialization script -->
    <script type="module">
        import { STATUS_EFFECTS } from './data/statusEffects.js';
        import { UNITS } from './data/unit.js';

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("Debug DOMContentLoaded: Starting game initialization...");

            const resolutionEngine = new ResolutionEngine('gameCanvas', 1920, 1080);
            const gl = resolutionEngine.getGLContext();

            const mercenaryPanelCanvas = document.getElementById('mercenaryPanelCanvas');
            const mercenaryPanelGl = mercenaryPanelCanvas ?
                mercenaryPanelCanvas.getContext('webgl', { alpha: true, antialias: true }) : null;

            const combatLogCanvas = document.getElementById('combatLogCanvas');
            const combatLogGl = combatLogCanvas ?
                combatLogCanvas.getContext('webgl', { alpha: true, antialias: true }) : null;

            if (!gl) {
                console.error("Debug: Failed to get main WebGL context. Debug game cannot run.");
                return;
            }

            const measurementEngine = new MeasurementEngine(resolutionEngine);
            const inputManager = new InputManager(resolutionEngine.canvas);
            const assetLoader = new AssetLoader(gl);
            const gameEngine = new GameEngine(measurementEngine);

            const cameraEngine = new CameraEngine(resolutionEngine);
            const layerEngine = new LayerEngine();
            const renderer = new Renderer(resolutionEngine, measurementEngine, cameraEngine, layerEngine, null, null);
            const panelEngine = new PanelEngine(measurementEngine, renderer);
            renderer.panels = panelEngine;

            const uiEngine = new UIEngine(measurementEngine, inputManager);
            renderer.ui = uiEngine;

            const turnEngine = new TurnEngine(gameEngine);
            const delayEngine = new DelayEngine();

            if (mercenaryPanelGl) renderer.addPanelContext('mercenaryPanelCanvas', mercenaryPanelGl, mercenaryPanelCanvas);
            if (combatLogGl) renderer.addPanelContext('combatLogCanvas', combatLogGl, combatLogCanvas);

            const debugManager = new DebugManager('gameCanvas', true);
            window.debugManagerInstance = debugManager;
            const fpsCounterElement = document.getElementById('fpsCounter');
            const memoryInfoElement = document.getElementById('memoryInfo');
            const mousePosElement = document.getElementById('mousePos');
            const touchPosElement = document.getElementById('touchPos');
            const gameTimeElement = document.getElementById('gameTime');
            const customDebugInfoElement = document.getElementById('customDebugInfo');

            const gridEngine = new GridEngine(measurementEngine, renderer);
            const battleLogEngine = new BattleLogEngine(panelEngine, measurementEngine);
            const battleStageManager = new BattleStageManager(assetLoader, renderer, cameraEngine, resolutionEngine);
            const battleGridManager = new BattleGridManager(gridEngine, cameraEngine, measurementEngine, resolutionEngine);
            const mercenaryPanelGridManager = new MercenaryPanelGridManager(gridEngine, panelEngine, measurementEngine);

            window.gameEngine = gameEngine;
            window.assetLoader = assetLoader;
            window.cameraEngine = cameraEngine;
            window.uiEngine = uiEngine;
            window.turnEngine = turnEngine;
            window.delayEngine = delayEngine;
            window.battleLogEngine = battleLogEngine;
            window.battleStageManager = battleStageManager;
            window.battleGridManager = battleGridManager;
            window.mercenaryPanelGridManager = mercenaryPanelGridManager;
            window.resolutionEngine = resolutionEngine;
            window.measurementEngine = measurementEngine;
            window.inputManager = inputManager;
            window.renderer = renderer;

            const battleCalculationManager = {
                requestDamageCalculation: (attackerId, defenderId, skillData) => {
                    console.log(`[Debug Main] Mock Battle Calculation Request: ${attackerId} attacks ${defenderId} with skill`, skillData);
                    setTimeout(() => {
                        console.log(`[Debug Main] Mock Battle Calculation Result for ${attackerId} vs ${defenderId}: Damage=25`);
                        battleLogEngine.addLog(`${attackerId}가 ${defenderId}에게 25 데미지를 입혔습니다! (시뮬레이션)`, 'yellow');
                    }, 500);
                }
            };
            window.battleCalculationManager = battleCalculationManager;

            const workflowManager = {
                triggerStatusEffectApplication: (unitId, statusEffectId) => {
                    console.log(`[Debug Main] Mock Workflow: Apply ${statusEffectId} to ${unitId}`);
                    battleLogEngine.addLog(`${unitId}에 ${STATUS_EFFECTS[statusEffectId.toUpperCase()]?.name || statusEffectId} 효과 적용 (시뮬레이션)`, 'purple');
                    if (!window.mockUnits) window.mockUnits = {};
                    if (!window.mockUnits[unitId]) window.mockUnits[unitId] = { id: unitId, effects: [] };
                    window.mockUnits[unitId].effects.push({ id: statusEffectId, duration: STATUS_EFFECTS[statusEffectId.toUpperCase()]?.duration || -1 });
                }
            };

            const turnCountManager = {
                clearAllEffects: () => {
                    console.log("[Debug Main] Mock TurnCountManager: Clear all effects.");
                    battleLogEngine.addLog("모든 유닛의 모든 효과를 제거했습니다. (시뮬레이션)", 'gray');
                    window.mockUnits = {};
                }
            };
            window.workflowManager = workflowManager;
            window.turnCountManager = turnCountManager;

            window.gameConfig = {
                enableDisarmSystem: true
            };

            const gameLoop = new GameLoop(gameEngine, renderer, panelEngine, uiEngine, delayEngine);

            gameEngine.initializeGame();

            const assetsToLoad = [
                { name: 'bg_music', type: 'audio', url: 'assets/audio/bg_music.mp3' },
                { name: 'merc_data', type: 'json', url: 'assets/data/mercenaries.json' },
                { name: battleStageManager.backgroundAssetId, type: 'image', url: battleStageManager.backgroundUrl }
            ];

            await new Promise(resolve => {
                assetLoader.load(
                    assetsToLoad,
                    (loaded, total) => {
                        console.log(`Debug: Loading assets: ${loaded}/${total}`);
                    },
                    () => {
                        console.log("Debug: All assets loaded. Starting game loop.");
                        battleStageManager.onAssetsLoaded();
                        resolve();
                    }
                );
            });

            panelEngine.registerPanel('mercenaryPanelCanvas', {
                width: measurementEngine.internalResolution.width,
                height: 100,
                x: 0, y: 0
            }, true);
            panelEngine.registerPanel('combatLogCanvas', {
                width: measurementEngine.internalResolution.width,
                height: 150,
                x: 0, y: measurementEngine.internalResolution.height - 150
            }, false);

            gameLoop.start();

            let totalGameTime = 0;
            const mainDebugLoopTick = (currentTime) => {
                const deltaTime = currentTime - (mainDebugLoopTick.lastTime || currentTime);
                mainDebugLoopTick.lastTime = currentTime;
                totalGameTime += deltaTime;

                if (debugManager.isEnabled) {
                    debugManager.update(deltaTime, totalGameTime, inputManager);
                    fpsCounterElement.textContent = debugManager.fps.toFixed(0);
                    memoryInfoElement.textContent = debugManager.debugInfo.memory;
                    mousePosElement.textContent = debugManager.debugInfo.mousePos;
                    touchPosElement.textContent = debugManager.debugInfo.touchPos;
                    gameTimeElement.textContent = debugManager.debugInfo.gameTime;
                    let customHtml = '';
                    for (const key in debugManager.debugInfo.custom) {
                        customHtml += `<span>${key}: ${debugManager.debugInfo.custom[key]}</span><br/>`;
                    }
                    customDebugInfoElement.innerHTML = customHtml || 'N/A';
                }
                requestAnimationFrame(mainDebugLoopTick);
            };
            requestAnimationFrame(mainDebugLoopTick);

            const toggleDisarmSystemBtn = document.getElementById('toggleDisarmSystemBtn');
            toggleDisarmSystemBtn.textContent = `무장해제 시스템: ${window.gameConfig.enableDisarmSystem ? '활성화됨' : '비활성화됨'}`;
            toggleDisarmSystemBtn.addEventListener('click', () => {
                const currentState = window.gameConfig.enableDisarmSystem;
                window.gameConfig.enableDisarmSystem = !currentState;
                toggleDisarmSystemBtn.textContent = `무장해제 시스템: ${!currentState ? '활성화됨' : '비활성화됨'}`;
                battleLogEngine.addLog(`무장해제 시스템이 ${!currentState ? '활성화' : '비활성화'}되었습니다. (디버그 토글)`, 'green');
                console.log(`[Debug Main] 무장해제 시스템이 ${!currentState ? '활성화' : '비활성화'}되었습니다.`);
            });

            let isSimulatingEvents = false;
            let eventSimTimeAccumulator = 0;
            const eventSimInterval = 5000;
            document.getElementById('simulateEventsBtn').addEventListener('click', (e) => {
                isSimulatingEvents = !isSimulatingEvents;
                e.target.textContent = isSimulatingEvents ? '이벤트 시뮬레이션 정지' : '이벤트 시뮬레이션 시작';
                if (!isSimulatingEvents) {
                    console.log("Debug: Event simulation stopped.");
                    battleLogEngine.addLog("이벤트 시뮬레이션 정지", 'orange');
                } else {
                    console.log("Debug: Event simulation started. Check console.");
                    battleLogEngine.addLog("이벤트 시뮬레이션 시작", 'orange');
                    eventSimTimeAccumulator = 0;
                }
            });

            requestAnimationFrame(function eventSimulatorLoop(timestamp) {
                const dt = timestamp - (eventSimulatorLoop.lastTime || timestamp);
                eventSimulatorLoop.lastTime = timestamp;

                if (isSimulatingEvents) {
                    eventSimTimeAccumulator += dt;
                    if (eventSimTimeAccumulator >= eventSimInterval) {
                        window.battleLogEngine.addLog("--- 시뮬레이션 이벤트 ---", "gray");
                        const attacker = UNITS.WARRIOR;
                        const defender = UNITS.SKELETON;
                        if (attacker && defender) {
                            battleLogEngine.addLog(`${attacker.name}이(가) ${defender.name}에게 공격! (시뮬레이션)`, 'yellow');
                        } else {
                            console.warn("Debug: WARRIOR or SKELETON units not found in data/unit.js for event simulation.");
                            battleLogEngine.addLog("경고: 시뮬레이션 유닛 데이터 없음", 'red');
                        }
                        eventSimTimeAccumulator -= eventSimInterval;
                    }
                }
                requestAnimationFrame(eventSimulatorLoop);
            });

            document.getElementById('testDamageCalculationBtn').addEventListener('click', () => {
                const warriorId = UNITS.WARRIOR?.id;
                const skeletonId = UNITS.SKELETON?.id;

                if (!warriorId || !skeletonId) {
                    console.error("Debug: WARRIOR or SKELETON unit data not loaded from data/unit.js. Cannot run damage test.");
                    battleLogEngine.addLog("유닛 데이터 로드 실패. 데미지 테스트 불가.", 'red');
                    return;
                }
                console.log("[Debug Main] Requesting damage calculation: WARRIOR attacks SKELETON");
                battleCalculationManager.requestDamageCalculation(warriorId, skeletonId, {
                    type: 'physical',
                    dice: { num: 1, sides: 6 }
                });
                setTimeout(() => {
                    console.log("[Debug Main] Requesting damage calculation again: WARRIOR attacks SKELETON");
                    battleCalculationManager.requestDamageCalculation(warriorId, skeletonId, {
                        type: 'physical',
                        dice: { num: 2, sides: 8 }
                    });
                }, 2000);
            });

            document.getElementById('applyPoisonToSkeletonBtn').addEventListener('click', () => {
                if (!UNITS.SKELETON) { console.error("Skeleton unit data not loaded."); return; }
                workflowManager.triggerStatusEffectApplication(UNITS.SKELETON.id, STATUS_EFFECTS.POISON.id);
            });
            document.getElementById('applyStunToSkeletonBtn').addEventListener('click', () => {
                if (!UNITS.SKELETON) { console.error("Skeleton unit data not loaded."); return; }
                workflowManager.triggerStatusEffectApplication(UNITS.SKELETON.id, STATUS_EFFECTS.STUN.id);
            });
            document.getElementById('applyBerserkToWarriorBtn').addEventListener('click', () => {
                if (!UNITS.WARRIOR) { console.error("Warrior unit data not loaded."); return; }
                workflowManager.triggerStatusEffectApplication(UNITS.WARRIOR.id, STATUS_EFFECTS.BERSERK.id);
            });
            document.getElementById('clearAllEffectsBtn').addEventListener('click', () => {
                turnCountManager.clearAllEffects();
            });

            console.log('Debug: Game initialization script finished.');
        });
    </script>
</body>
</html>
